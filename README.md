# onecode-rs

Rust bindings for [ONEcode](https://github.com/thegenemyers/ONEcode), a simple and efficient data representation format for genomic data.

## Overview

ONEcode is a data representation framework designed primarily for genomic data, providing both human-readable ASCII and compressed binary file versions with strongly typed data.

This library provides safe, idiomatic Rust bindings to the ONEcode C library.

## Features

- ✅ Read and write ONE files in both ASCII and binary formats
- ✅ Schema validation and creation
- ✅ Provenance and reference tracking
- ✅ Type-safe access to fields (integers, reals, characters, strings, lists)
- ✅ File navigation and statistics
- ✅ RAII-based resource management

## Installation

Add this to your `Cargo.toml`:

```toml
[dependencies]
onecode = { path = "path/to/onecode-rs" }
```

## Usage

### Reading a ONE file

```rust
use onecode::OneFile;

fn main() -> Result<(), Box<dyn std::error::Error>> {
    let mut file = OneFile::open_read("data.1seq", None, None, 1)?;

    // Read through the file
    loop {
        let line_type = file.read_line();
        if line_type == '\0' {
            break; // End of file
        }

        match line_type {
            'S' => {
                // Access DNA sequence data
                println!("Sequence line");
            },
            'I' => {
                // Access identifier string
                println!("ID: {}", file.int(0));
            },
            _ => {}
        }
    }

    Ok(())
}
```

### Writing a ONE file

```rust
use onecode::{OneFile, OneSchema};

fn main() -> Result<(), Box<dyn std::error::Error>> {
    // Create a schema
    let schema_text = "P 3 tst\nO T 1 3 INT\n";
    let schema = OneSchema::from_text(schema_text)?;

    // Open file for writing
    let mut writer = OneFile::open_write_new(
        "output.1tst",
        &schema,
        "tst",
        false,  // ASCII format
        1       // single-threaded
    )?;

    // Add provenance
    writer.add_provenance("myprogram", "1.0", "example command")?;

    // Write data
    writer.set_int(0, 42);
    writer.write_line('T', 0, None);

    // File is automatically closed on drop
    Ok(())
}
```

### Getting file statistics

```rust
use onecode::OneFile;

fn main() -> Result<(), Box<dyn std::error::Error>> {
    let file = OneFile::open_read("data.1seq", None, None, 1)?;

    // Get statistics for a line type
    let (count, max_length, total_length) = file.stats('S')?;
    println!("Sequences: {}, Max length: {}, Total: {}",
             count, max_length, total_length);

    Ok(())
}
```

## Building

The library uses `bindgen` to automatically generate bindings from the C headers and `cc` to compile the C library.

```bash
cargo build
```

## Testing

Run tests with single-threaded execution (required due to thread safety issues in the C library):

```bash
cargo test -- --test-threads=1
```

All 9 integration tests pass successfully.

## Thread Safety

The ONEcode C library has known thread-safety issues when used from multiple threads simultaneously:

1. **`OneSchema::from_text()`** - Fixed with a Rust-level mutex to prevent race conditions in temporary file handling
2. **General file operations** - May have issues with unrestricted parallelism due to potential global state in the C library

**Recommendation**: Run tests with `--test-threads=1` and use external synchronization if accessing ONE files from multiple threads in production.

See [THREAD_SAFETY.md](THREAD_SAFETY.md) for detailed analysis and workarounds.

## Architecture

The library is organized into several modules:

- `ffi` - Raw FFI bindings generated by bindgen
- `error` - Rust error types and Result wrapper
- `types` - Rust-friendly type definitions
- `file` - Safe `OneFile` wrapper
- `schema` - `OneSchema` management

## Integration with ONEcode

The C library is included as a git subtree in the `ONEcode/` directory and compiled automatically during the build process.

To update the ONEcode subtree:

```bash
git subtree pull --prefix ONEcode https://github.com/thegenemyers/ONEcode.git main --squash
```

## License

This Rust wrapper is licensed under MIT OR Apache-2.0.

The ONEcode C library has its own license - see `ONEcode/` for details.

## Contributing

Contributions are welcome! Please ensure tests pass before submitting PRs:

```bash
cargo test -- --test-threads=1
cargo clippy
cargo fmt
```
